version: '3.8'
# Note: cgroupns_mode requires Docker Compose v2.1+ or use 'docker run --cgroupns host'
# For full CWS compatibility, ensure Docker version 20.10+ is installed

services:
  mysql:
    image: mysql:8.0
    container_name: pizzacoffee-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpass123
      MYSQL_DATABASE: pizzacoffee
      MYSQL_USER: pizzauser
      MYSQL_PASSWORD: pizzapass123
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - pizzacoffee-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpass123"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build: .
    container_name: pizzacoffee-app
    environment:
      NODE_ENV: production
      PORT: 3000
      SESSION_SECRET: ${SESSION_SECRET:-insecure-secret-change-me}

      # Database
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: pizzauser
      DB_PASSWORD: pizzapass123
      DB_NAME: pizzacoffee

      # Datadog Configuration
      DD_API_KEY: ${DD_API_KEY}
      DD_SITE: ${DD_SITE:-datadoghq.com}
      DD_SERVICE: insecure-pizza-coffee
      DD_ENV: ${DD_ENV:-production}
      DD_VERSION: 1.0.0
      DD_TRACE_ENABLED: true
      DD_LOGS_INJECTION: true
      DD_RUNTIME_METRICS_ENABLED: true
      DD_PROFILING_ENABLED: true

      # Application Security Management (ASM)
      DD_APPSEC_ENABLED: true
      DD_APPSEC_WAF_TIMEOUT: 5000
      DD_APPSEC_RATE_LIMIT: 100
      DD_APPSEC_BLOCKING_ENABLED: ${DD_APPSEC_BLOCKING_ENABLED:-false}
      DD_APPSEC_SCA_ENABLED: true

      # API Security
      DD_API_SECURITY_ENABLED: true
      DD_API_SECURITY_REQUEST_SAMPLE_RATE: 1.0

      # IAST
      DD_IAST_ENABLED: true
      DD_IAST_REQUEST_SAMPLING: 100
      DD_IAST_MAX_CONCURRENT_REQUESTS: 2
      DD_IAST_MAX_CONTEXT_OPERATIONS: 2

      # Remote Configuration
      DD_REMOTE_CONFIGURATION_ENABLED: true

      # Datadog APM
      DD_TRACE_SAMPLE_RATE: 1.0
      DD_TRACE_ANALYTICS_ENABLED: true
      # Datadog Agent
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_AGENT_PORT: 8126

    ports:
      - "3000:3000"
    depends_on:
      mysql:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    networks:
      - pizzacoffee-network
    volumes:
      - ./src:/app/src
    restart: unless-stopped

  datadog-agent:
    image: gcr.io/datadoghq/agent:latest
    container_name: datadog-agent
    pid: host
    ipc: host
    environment:
      DD_API_KEY: ${DD_API_KEY}
      DD_SITE: ${DD_SITE:-datadoghq.com}
      DD_HOSTNAME: pizzacoffee-docker
      DD_TAGS: "env:${DD_ENV:-production} service:insecure-pizza-coffee"

      # APM
      DD_APM_ENABLED: true
      DD_APM_NON_LOCAL_TRAFFIC: true
      DD_APM_RECEIVER_PORT: 8126

      # Application Security Management
      DD_APPSEC_ENABLED: true
      DD_APPSEC_SCA_ENABLED: true

      # Cloud Workload Security (CWS) - Runtime Security
      DD_RUNTIME_SECURITY_CONFIG_ENABLED: true
      DD_RUNTIME_SECURITY_CONFIG_REMOTE_CONFIGURATION_ENABLED: true

      # Compliance and Host Benchmarks
      DD_COMPLIANCE_CONFIG_ENABLED: true
      DD_COMPLIANCE_CONFIG_HOST_BENCHMARKS_ENABLED: true

      # Host Root for CWS file integrity monitoring
      HOST_ROOT: /host/root

      # Remote Configuration
      DD_REMOTE_CONFIGURATION_ENABLED: true

      # Process monitoring
      DD_PROCESS_AGENT_ENABLED: true
      DD_CONTAINER_EXCLUDE: "name:datadog-agent"

      # Logs
      DD_LOGS_ENABLED: true
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: true

      # Docker integration
      DD_CONTAINER_LABELS_AS_TAGS: '{"*":"%%label%%"}'

    ports:
      - "8126:8126"
    volumes:
      # Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Host proc for process monitoring
      - /proc/:/host/proc/:ro
      # Host cgroup for container metrics
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      # User and group info for CWS
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      # Host root filesystem for CWS file integrity monitoring
      - /:/host/root:ro
      # Kernel debug for eBPF-based monitoring
      - /sys/kernel/debug:/sys/kernel/debug
      # OS release information
      - /etc/os-release:/etc/os-release:ro
    networks:
      - pizzacoffee-network
    cap_add:
      - SYS_ADMIN
      - SYS_RESOURCE
      - SYS_PTRACE
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
      - IPC_LOCK
      - CHOWN
    security_opt:
      - apparmor:unconfined
    restart: unless-stopped

networks:
  pizzacoffee-network:
    driver: bridge

volumes:
  mysql_data:
